# 友谊农场智慧农业平台：UI/交互全面改造 + 重新部署方案（可执行版）

> 目标：在**不改变核心业务逻辑**（机队监控、作业、交易、会员权限、地图）前提下，提升“正式运行”体验的一致性、可理解性和稳定性，并提供一套可重复的上线/回滚流程。

---

## 0. 当前事实（与代码对齐）

- **前端**：Vite + React + TypeScript + TailwindCSS（见 `package.json`）
- **路由**：Wouter（见 `client/src/App.tsx`）
- **后端**：Express + tRPC + Drizzle + MySQL（见 `server/`、`drizzle/`）
- **构建产物**：
  - 前端：`dist/public/`
  - 后端：`dist/index.js`（`pnpm build` 会同时构建前端与后端）
- **地图**：以 `JL1SatelliteMap`（吉林一号）为主，部分历史文档仍提到高德（需纠正）

---

## 1. 需要“重新审视”的 UI/交互核心问题（按影响分级）

### P0（上线阻断：会让用户认为产品不可信/不可用）
- **导航与内容不一致**：顶栏切到“会员/认证”但左侧仍显示“机队面板/Brands”等无关信息，造成“我在哪/我该做什么”困惑。
- **正式运行 vs 模拟运行混杂**：正式运行应面向真实作业；模拟运行用于演示培训。两者的入口、提示、数据来源、功能可用范围需要明确。
- **错误与空状态缺失**：接口不可用、密钥未配、未登录、无权限、无数据时，必须有明确的说明与下一步指引。

### P1（高优先级：影响效率与学习成本）
- **信息架构偏“炫技”**：Apple 毛玻璃与工业监控风混用，导致层级不清；关键任务（看设备、看地块、看作业、处理告警、发单/接单）路径不够短。
- **跨页面交互缺少闭环**：地图/列表/右侧详情的联动不稳定，选中态和过滤条件不能在页面切换中保持。
- **文案与标签不统一**：中英文、大小写、术语（Brands/品牌）混用；“升级/认证/注册审核中心”含义重叠。

### P2（中优先级：影响专业感）
- **表格与列表可读性**：列宽、溢出、关键字段优先级、排序/筛选一致性不足。
- **视觉规范不统一**：同类按钮/卡片/徽标在不同页面的尺寸、间距、颜色语义不一致。

---

## 2. 目标体验（正式运行）

### 2.1 用户任务优先级（从高到低）
- **农场主/调度**：全局态势（在哪些地块、哪些设备、是否异常）→ 选设备/地块 → 看详情/轨迹/作业量 → 下达任务/处理异常
- **机手/机队**：我的设备状态 → 今天要干什么 → 轨迹/效率/油耗 → 故障与保养提醒
- **运营/管理员**：审核、配置、订单/会员/日志、风险操作二次确认

### 2.2 信息架构（建议）
- **顶栏**：全局模块导航（机队/作业/回放/分析/交易/告警）+ 用户（会员/认证/退出）
- **左侧**：与当前模块强相关的二级面板（设备筛选/地块筛选/告警筛选/交易筛选）
- **中间**：地图/主内容
- **右侧**：选中对象详情 + 快捷操作（跟随选中态）

---

## 3. 改造路线图（分阶段、可持续上线）

### Phase 0：交互一致性“止血”（1-2 天）
目标：让正式运行的每个页面“看起来像同一个系统”，用户不会迷路。

交付：
- **导航状态单一来源**：以路由为准推导顶栏 activeTab、左侧 activePanel、右侧 detailPanel。
- **正式/模拟隔离**：明确入口与标识；模拟模式页面禁止进入“正式交易/运营”动作（或给出提示）。
- **空状态/错误状态标准化**：未登录/无权限/无数据/加载失败 → 统一组件与文案模板。

验收：
- 任意页面刷新（hard reload），顶栏/左栏/右栏状态一致。
- 未登录访问受保护页面不崩溃，给出“去登录”按钮。

### Phase 1：视觉与组件规范（3-5 天）
目标：建立“工业可信”的 UI 规则，减少随意性与重复实现。

交付：
- **Design Tokens**：颜色语义（成功/警告/危险/信息）、间距、圆角、阴影、字体层级。
- **组件规范化**：Button/Badge/Card/Table/EmptyState/ErrorBanner/StatCard 统一。
- **文案统一**：统一中文为主、英文为辅；去掉 Brands 等混杂用词；对“会员/认证/注册审核”做清晰命名。

验收：
- 关键页面（机队/作业/告警/会员）视觉一致，组件复用率提升（减少重复 CSS/逻辑）。

### Phase 2：地图+列表联动与可读性（3-7 天）
目标：把“地图是底图”升级为“地图是工作台”，提升调度效率。

交付：
- 选中设备/地块时：列表高亮、地图聚焦、右侧详情刷新。
- 过滤条件：品牌/状态/地块/日期在页面切换可保留（URL query 或 context）。
- 表格：支持搜索/筛选/排序；关键列前置；长文案不截断或提供 hover/展开。

验收：
- 机队管理：从“找一台设备”到“看到详情并定位”的路径 ≤ 3 次点击。

### Phase 3：上线级可靠性（持续）
目标：降低线上故障率与排障成本。

交付：
- 性能预算（首屏、交互延迟、资源大小）+ 监控埋点（错误、慢请求、白屏）。
- 日志与审计：关键操作（发布/审核/支付模拟/删除）记录。
- 安全回归：权限校验（前后端一致）+ 危险操作二次确认。

---

## 4. 重新部署方案（推荐：全栈部署）

> 你们当前架构是“一个 Node 服务同时提供 API + 静态资源”。这类项目不适合 Netlify 纯静态托管（除非把 API 拆出去）。

### 4.1 生产环境推荐架构
- **ECS/云服务器**：Ubuntu 22.04+
- **Node.js**：22.x（与项目脚本一致）
- **MySQL**：8.x（建议独立实例/云数据库）
- **Nginx**：反向代理 + TLS + 静态缓存
- **进程管理**：systemd 或 PM2（二选一）

### 4.2 环境变量（生产必备）
以 `.env.example` 为模板，生产至少需要：
- `DATABASE_URL`
- `JWT_SECRET`
- `PORT`
- 地图相关：`VITE_JL1_MAP_MK`、`VITE_JL1_MAP_TK`、（可选）`VITE_JL1_MAP_PRO`、`VITE_JL1_MAP_BASE_URL`
- 业务可选：`OAUTH_SERVER_URL`、`VITE_APP_ID` 等

### 4.3 标准上线流程（可复制）
1) **拉代码/发包**
- 方式 A：服务器 `git pull`
- 方式 B：本地 build 后上传（更可控）

2) **安装依赖**
- `pnpm install --frozen-lockfile`

3) **数据库迁移**
- `pnpm db:push`

4) **（可选）灌演示数据**
- `node seed-db.mjs`

5) **构建**
- `pnpm build`（生成 `dist/index.js` + `dist/public`）

6) **启动/重启**
- `pnpm start` 或 `node dist/index.js`

7) **健康检查**
- `curl -I http://127.0.0.1:$PORT/`
- 关键页面：`/dashboard`、`/dashboard/overview`

### 4.4 Nginx 反代（示例）
- 80/443 → 反代到 `127.0.0.1:3000`
- 静态资源缓存：`/assets/*` 可缓存 1 年
- HTML 不缓存（保证版本更新即时生效）

### 4.5 灰度与回滚（强烈建议）
- **蓝绿目录**：`/opt/app/releases/<timestamp>/`
- **切换软链**：`/opt/app/current -> releases/<timestamp>`
- 回滚就是把软链切回上一版并重启进程（≤ 1 分钟）

---

## 5. CI/CD（建议的最低配）

### 5.1 PR 质量门禁（必须）
- `pnpm check`
- `pnpm test`
- `pnpm build`

### 5.2 发布策略
- `main`：可部署
- `release/*`：预发布（灰度）
- `hotfix/*`：紧急修复

---

## 6. 交付清单（你可以拿它做验收）

### UI/交互
- [ ] 顶栏/左栏/右栏与路由一致，刷新不漂移
- [ ] 未登录/无权限/无数据/错误有统一提示与下一步
- [ ] 关键任务路径清晰：看设备→定位→看详情→处理/下发
- [ ] 文案统一为中文主导、术语一致

### 上线
- [ ] `.env` 生产配置齐全，密钥不入库不入 git
- [ ] 迁移可重复执行（幂等）并有回滚策略
- [ ] 构建产物可复现（锁文件一致）
- [ ] 有健康检查与回滚脚本/步骤

