# 原始版本深度分析

## 原始版本的关键设计

### 1. 设备数据结构
每台设备包含完整的属性：
- `id`, `name`, `serial` - 标识信息
- `type` - 设备类型（harvester/tractor）
- `status`, `statusText` - 状态
- `fuel`, `def`, `load` - 运行参数
- `lat`, `lng`, `heading` - **精确的位置信息**
- `yield`, `moisture`, `grainTank`, `totalYield`, `areaWorked` - 作业数据
- `params` - 详细运行参数

### 2. 坐标设计的智慧

| 设备 | 纬度 | 经度 | 位置描述 |
|------|------|------|----------|
| 约翰迪尔 S770 | 46.755 | 131.845 | 中心偏西南 |
| 凯斯 7130 | 46.760 | 131.880 | 东北角 |
| 约翰迪尔 7M-2204 | 46.745 | 131.850 | 南部中央 |
| 凯斯 Puma 2104 (A) | 46.750 | 131.860 | 中心偏东 |
| 凯斯 Puma 2104 (B) | 46.770 | 131.830 | 西北角 |

**坐标分布特点**：
- 5台设备均匀分布在 3km x 3.5km 范围内
- 每台设备间隔约 1-2km
- 没有设备重叠
- **所有坐标都在农田内**

### 3. fluctuate函数的正确实现

```typescript
export const fluctuate = (base: number, variance: number, min: number = 0, max: number = 10000) => {
  const change = (Math.random() - 0.5) * variance;
  let newValue = base + change;
  return Math.max(min, Math.min(max, newValue));
};
```

**关键点**：
- 有4个参数：base, variance, min, max
- 使用 `Math.max(min, Math.min(max, newValue))` 确保结果在范围内
- 默认max是10000，但调用时可以指定更小的值

### 4. 为什么原始版本能工作

1. **坐标是硬编码的** - 不是随机生成的
2. **每个坐标都经过验证** - 确保在农田内
3. **范围小而精确** - 3km x 3.5km
4. **fluctuate有边界保护** - 不会超出范围

---

## 我需要做的修改

### 核心思路
**保持原始版本的设计智慧，只是扩展设备数量**

### 具体方案

1. **坐标范围**：严格使用 46.745-46.770°N, 131.830-131.880°E

2. **设备生成**：
   - 在这个范围内划分4个象限
   - 每个象限分配一个品牌
   - 每台设备的坐标 = 象限中心 + 小范围随机偏移（±0.002度，约200米）

3. **边界保护**：
   - 所有坐标生成后必须检查是否在边界内
   - 超出边界的坐标要拉回边界内

4. **fluctuate函数**：
   - 保持原始版本的4参数设计
   - 坐标波动时使用严格的min/max

### 象限划分

```
        131.830        131.855        131.880
46.770  ┌──────────────┬──────────────┐
        │   西北区     │   东北区     │
        │ john_deere   │   case_ih    │
46.7575 ├──────────────┼──────────────┤
        │   西南区     │   东南区     │
        │ new_holland  │    claas     │
46.745  └──────────────┴──────────────┘
```

### 每个象限的坐标范围

| 象限 | 品牌 | 纬度范围 | 经度范围 | 中心点 |
|------|------|----------|----------|--------|
| 西北 | 约翰迪尔 | 46.7575-46.770 | 131.830-131.855 | (46.764, 131.843) |
| 东北 | 凯斯 | 46.7575-46.770 | 131.855-131.880 | (46.764, 131.868) |
| 西南 | 纽荷兰 | 46.745-46.7575 | 131.830-131.855 | (46.751, 131.843) |
| 东南 | 克拉斯 | 46.745-46.7575 | 131.855-131.880 | (46.751, 131.868) |

### 设备分布

每个象限约20台设备：
- 约翰迪尔：18收割机 + 5运粮车 = 23台 → 西北区
- 凯斯：15收割机 + 5运粮车 = 20台 → 东北区
- 纽荷兰：14收割机 + 5运粮车 = 19台 → 西南区
- 克拉斯：13收割机 + 5运粮车 = 18台 → 东南区

每台设备在象限内的位置 = 象限中心 + 随机偏移（±0.002度）
